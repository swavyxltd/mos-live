generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Application {
  id                 String             @id
  orgId              String
  status             String             @default("NEW")
  guardianName       String
  guardianPhone      String
  guardianEmail      String
  guardianAddress    String?
  preferredClass     String?
  preferredTerm      String?
  preferredStartDate DateTime?
  additionalNotes    String?
  adminNotes         String?
  submittedAt        DateTime           @default(now())
  reviewedAt         DateTime?
  reviewedById       String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  Org                Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User               User?              @relation(fields: [reviewedById], references: [id])
  ApplicationChild   ApplicationChild[]
}

model ApplicationChild {
  id            String      @id
  applicationId String
  firstName     String
  lastName      String
  dob           DateTime?
  gender        String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  Application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model Attendance {
  id        String   @id
  orgId     String
  classId   String
  studentId String
  date      DateTime
  status    String
  Class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId, date])
}

model AuditLog {
  id          String   @id
  orgId       String?
  actorUserId String?
  action      String
  targetType  String
  targetId    String?
  data        String?
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [actorUserId], references: [id])
  Org         Org?     @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Class {
  id                   String                 @id
  orgId                String
  name                 String
  description          String?
  schedule             String
  teacherId            String?
  isArchived           Boolean                @default(false)
  archivedAt           DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  monthlyFeeP          Int?
  feeDueDay            Int?
  Attendance           Attendance[]
  Org                  Org                    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User                 User?                  @relation(fields: [teacherId], references: [id])
  Event                Event[]
  Exam                 Exam[]
  MonthlyPaymentRecord MonthlyPaymentRecord[]
  StudentClass         StudentClass[]
}

model Event {
  id          String   @id
  orgId       String
  title       String
  type        String
  date        DateTime
  startTime   String?
  endTime     String?
  location    String?
  teacher     String?
  description String?
  classId     String?
  studentId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Class       Class?   @relation(fields: [classId], references: [id], onDelete: Cascade)
  Student     Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  Org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Exam {
  id        String   @id
  orgId     String
  title     String
  date      DateTime
  classId   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  Class     Class?   @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model FeesPlan {
  id        String   @id
  orgId     String
  name      String
  amountP   Int
  cadence   String   @default("MONTHLY")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Holiday {
  id        String   @id
  orgId     String
  name      String
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Invitation {
  id         String    @id
  orgId      String
  email      String?
  phone      String?
  role       String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())
  Org        Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Invoice {
  id         String    @id
  orgId      String
  studentId  String
  amountP    Int
  dueDate    DateTime
  status     String    @default("DRAFT")
  paidAt     DateTime?
  paidMethod String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  Org        Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student    Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  Payment    Payment[]
}

model Message {
  id        String   @id
  orgId     String
  title     String
  body      String
  audience  String
  channel   String
  status    String   @default("DRAFT")
  targets   String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model MonthlyPaymentRecord {
  id        String    @id
  orgId     String
  studentId String
  classId   String
  month     String
  amountP   Int
  method    String?
  status    String    @default("PENDING")
  paidAt    DateTime?
  notes     String?
  reference String?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  Class     Class     @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org       Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student   Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, month])
  @@index([orgId, month])
  @@index([status])
}

model Org {
  id                   String                 @id
  name                 String
  slug                 String                 @unique
  timezone             String                 @default("Europe/London")
  settings             String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  status               String                 @default("ACTIVE")
  pausedAt             DateTime?
  pausedReason         String?
  lastPaymentDate      DateTime?
  paymentFailureCount  Int                    @default(0)
  autoSuspendEnabled   Boolean                @default(true)
  address              String?
  phone                String?
  email                String?
  officeHours          String?
  stripeEnabled        Boolean                @default(false)
  stripePublishableKey String?
  stripeSecretKey      String?
  stripeWebhookSecret  String?
  autoPaymentEnabled   Boolean                @default(true)
  cashPaymentEnabled   Boolean                @default(true)
  bankTransferEnabled  Boolean                @default(true)
  paymentInstructions  String?
  bankAccountName      String?
  bankSortCode         String?
  bankAccountNumber    String?
  addressLine1         String?
  city                 String?
  postcode             String?
  publicEmail          String?
  publicPhone          String?
  feeDueDay            Int?                   @default(1)
  deactivatedAt        DateTime?
  deactivatedReason    String?
  Application          Application[]
  Attendance           Attendance[]
  AuditLog             AuditLog[]
  Class                Class[]
  Event                Event[]
  Exam                 Exam[]
  FeesPlan             FeesPlan[]
  Holiday              Holiday[]
  Invitation           Invitation[]
  Invoice              Invoice[]
  Message              Message[]
  MonthlyPaymentRecord MonthlyPaymentRecord[]
  ParentBillingProfile ParentBillingProfile[]
  ParentInvitation     ParentInvitation[]
  Payment              Payment[]
  PlatformOrgBilling   PlatformOrgBilling?
  ProgressLog          ProgressLog[]
  Student              Student[]
  StudentClass         StudentClass[]
  SupportTicket        SupportTicket[]
  Term                 Term[]
  UserOrgMembership    UserOrgMembership[]
  GiftAidSubmission    GiftAidSubmission[]
  ConvertedLeads       Lead[]
}

model GiftAidSubmission {
  id            String   @id @default(cuid())
  orgId         String
  generatedById String
  startDate     DateTime
  endDate       DateTime
  totalAmount   Float
  totalCount    Int
  filename      String
  createdAt     DateTime @default(now())
  Org           Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  GeneratedBy   User     @relation(fields: [generatedById], references: [id])

  @@index([orgId])
  @@index([generatedById])
  @@index([createdAt])
}

model ParentBillingProfile {
  id                     String   @id
  orgId                  String
  parentUserId           String   @unique
  stripeCustomerId       String?
  defaultPaymentMethodId String?
  autoPayEnabled         Boolean  @default(false)
  preferredPaymentMethod String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime
  Org                    Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User                   User     @relation(fields: [parentUserId], references: [id], onDelete: Cascade)

  @@unique([orgId, parentUserId])
}

model ParentInvitation {
  id          String    @id
  orgId       String
  studentId   String
  parentEmail String
  token       String    @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  Org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([parentEmail])
  @@index([token])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Payment {
  id         String   @id
  orgId      String
  invoiceId  String
  method     String
  amountP    Int
  status     String   @default("PENDING")
  providerId String?
  meta       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  Org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model PlatformOrgBilling {
  id                       String    @id
  orgId                    String    @unique
  stripeCustomerId         String?
  stripeSubscriptionItemId String?
  lastUsageReportedAt      DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime
  billingAnniversaryDate   Int?
  defaultPaymentMethodId   String?
  lastBilledAt             DateTime?
  lastBilledStudentCount   Int?
  stripeSubscriptionId     String?
  subscriptionStatus       String?
  trialEndDate             DateTime?
  firstPaymentFailureDate  DateTime?
  paymentRetryCount        Int       @default(0)
  lastPaymentRetryDate     DateTime?
  warningEmailSent         Boolean   @default(false)
  Org                      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model ProgressLog {
  id          String   @id
  orgId       String
  studentId   String
  body        String
  createdById String
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [createdById], references: [id])
  Org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Student {
  id                   String                 @id
  orgId                String
  firstName            String
  lastName             String
  dob                  DateTime?
  allergies            String?
  medicalNotes         String?
  primaryParentId      String?
  isArchived           Boolean                @default(false)
  archivedAt           DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  Attendance           Attendance[]
  Invoice              Invoice[]
  MonthlyPaymentRecord MonthlyPaymentRecord[]
  ParentInvitation     ParentInvitation[]
  ProgressLog          ProgressLog[]
  Event                Event[]
  Org                  Org                    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User                 User?                  @relation(fields: [primaryParentId], references: [id])
  StudentClass         StudentClass[]
}

model StudentClass {
  id        String  @id
  orgId     String
  studentId String
  classId   String
  Class     Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org       Org     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
}

model SupportTicket {
  id                    String                  @id
  orgId                 String
  createdById           String?
  role                  String
  subject               String
  body                  String
  status                String                  @default("OPEN")
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  User                  User?                   @relation(fields: [createdById], references: [id])
  Org                   Org                     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  SupportTicketResponse SupportTicketResponse[]
}

model SupportTicketResponse {
  id            String        @id
  ticketId      String
  body          String
  createdById   String
  createdAt     DateTime      @default(now())
  User          User          @relation(fields: [createdById], references: [id])
  SupportTicket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model Term {
  id        String   @id
  orgId     String
  name      String
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model User {
  id                     String                  @id
  name                   String?
  email                  String                  @unique
  emailVerified          DateTime?
  image                  String?
  phone                  String?
  password               String?
  address                String?
  city                   String?
  postcode               String?
  title                  String? // Title (Mr, Mrs, Miss, Ms, Dr, etc.) for Gift Aid
  giftAidStatus          String? // 'YES', 'NO', 'NOT_SURE'
  giftAidDeclaredAt      DateTime?
  isSuperAdmin           Boolean                 @default(false)
  isArchived             Boolean                 @default(false)
  archivedAt             DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  failedLoginAttempts    Int                     @default(0)
  lastFailedLoginAttempt DateTime?
  lockedUntil            DateTime?
  lastTwoFactorAt        DateTime?
  twoFactorCode          String?
  twoFactorCodeExpiry    DateTime?
  twoFactorEnabled       Boolean                 @default(true)
  Account                Account[]
  Application            Application[]
  AuditLog               AuditLog[]
  Class                  Class[]
  ParentBillingProfile   ParentBillingProfile?
  PasswordResetToken     PasswordResetToken[]
  ProgressLog            ProgressLog[]
  Session                Session[]
  Student                Student[]
  SupportTicket          SupportTicket[]
  SupportTicketResponse  SupportTicketResponse[]
  UserOrgMembership      UserOrgMembership[]
  GiftAidSubmission      GiftAidSubmission[]
  AssignedLeads          Lead[]
  CreatedLeadActivities  LeadActivity[]
}

model UserOrgMembership {
  id             String                      @id
  userId         String
  orgId          String
  role           String
  staffSubrole   String? // ADMIN, TEACHER, FINANCE_OFFICER, or null for custom
  isInitialAdmin Boolean                     @default(false)
  Org            Org                         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User           User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  Permissions    StaffPermissionAssignment[]

  @@unique([userId, orgId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model StaffPermission {
  id          String                      @id
  key         String                      @unique // e.g., 'access_dashboard', 'access_classes'
  name        String // Display name
  description String? // Optional description
  category    String? // Group permissions (e.g., 'pages', 'actions')
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime
  Assignments StaffPermissionAssignment[]
}

model StaffPermissionAssignment {
  id           String            @id
  membershipId String
  permissionId String
  createdAt    DateTime          @default(now())
  Membership   UserOrgMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  Permission   StaffPermission   @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([membershipId, permissionId])
  @@index([membershipId])
}

model platform_settings {
  id                          String    @id
  defaultTimezone             String    @default("Europe/London")
  trialPeriodDays             Int       @default(14)
  logoUrl                     String?
  faviconUrl                  String?
  resendApiKey                String?
  emailFromAddress            String?   @default("Madrasah OS <noreply@madrasah.io>")
  maintenanceMode             Boolean   @default(false)
  maintenanceMessage          String?
  scheduledMaintenanceAt      DateTime?
  basePricePerStudent         Int       @default(100)
  billingDayOfMonth           Int       @default(1)
  gracePeriodDays             Int       @default(14)
  autoBillingEnabled          Boolean   @default(true)
  billingNotificationsEnabled Boolean   @default(true)
  stripePublishableKey        String?
  stripeSecretKey             String?
  stripeWebhookSecret         String?
  stripeTestMode              Boolean   @default(true)
  passwordMinLength           Int       @default(8)
  passwordRequireUppercase    Boolean   @default(true)
  passwordRequireLowercase    Boolean   @default(true)
  passwordRequireNumbers      Boolean   @default(true)
  passwordRequireSpecial      Boolean   @default(false)
  ownerCalendlyUrl            String?
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime
}

model Lead {
  id                      String         @id @default(cuid())
  orgName                 String
  city                    String?
  country                 String         @default("UK")
  estimatedStudents       Int?
  contactName             String?
  contactEmail            String?
  contactPhone            String?
  status                  String         @default("NEW") // NEW, CONTACTED, FOLLOW_UP, DEMO_BOOKED, WON, LOST, ON_HOLD
  source                  String?
  lastContactAt           DateTime?
  nextContactAt           DateTime?
  notes                   String?        @db.Text
  assignedToUserId        String?
  convertedOrgId          String?
  lastEmailSentAt         DateTime?
  lastEmailStage          String?        // INITIAL, FOLLOW_UP_1, FOLLOW_UP_2, FINAL
  emailOutreachCompleted  Boolean         @default(false)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  AssignedTo              User?          @relation(fields: [assignedToUserId], references: [id])
  ConvertedOrg            Org?           @relation(fields: [convertedOrgId], references: [id])
  Activities              LeadActivity[]

  @@index([status])
  @@index([assignedToUserId])
  @@index([nextContactAt])
  @@index([status, assignedToUserId])
  @@index([convertedOrgId])
  @@index([emailOutreachCompleted, nextContactAt])
  @@index([lastEmailStage])
}

model LeadActivity {
  id              String   @id @default(cuid())
  leadId          String
  type            String // CALL, WHATSAPP, EMAIL, MEETING, NOTE, STATUS_CHANGE
  description     String   @db.Text
  outcome         String?  // For CALL type: "No answer", "Busy / Couldn't talk", "Spoke – interested", "Spoke – not interested", "Asked to call back later", "Wrong number"
  createdAt       DateTime @default(now())
  createdByUserId String?
  Lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  CreatedBy       User?    @relation(fields: [createdByUserId], references: [id])

  @@index([leadId])
  @@index([createdAt])
  @@index([type])
}
