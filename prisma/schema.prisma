generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Application {
  id                       String             @id
  orgId                    String
  status                   String             @default("NEW")
  guardianName             String
  guardianPhone            String
  guardianEmail            String
  guardianAddress          String?
  preferredClass           String?
  preferredTerm            String?
  preferredStartDate       DateTime?
  additionalNotes          String?
  adminNotes               String?
  submittedAt              DateTime           @default(now())
  reviewedAt               DateTime?
  reviewedById             String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime
  // Application acceptance token for parent signup
  acceptanceToken          String?            @unique
  acceptanceTokenExpiresAt DateTime?
  acceptanceTokenUsedAt    DateTime?
  Org                      Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User                     User?              @relation(fields: [reviewedById], references: [id])
  ApplicationChild         ApplicationChild[]

  @@index([acceptanceToken])
  @@index([status])
}

model ApplicationChild {
  id            String      @id
  applicationId String
  firstName     String
  lastName      String
  dob           DateTime?
  gender        String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  Application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model Attendance {
  id        String   @id
  orgId     String
  classId   String
  studentId String
  date      DateTime
  status    String
  Class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId, date])
}

model AuditLog {
  id          String   @id
  orgId       String?
  actorUserId String?
  action      String
  targetType  String
  targetId    String?
  data        String?
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [actorUserId], references: [id])
  Org         Org?     @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Class {
  id                   String                 @id
  orgId                String
  name                 String
  description          String?
  schedule             String
  teacherId            String?
  isArchived           Boolean                @default(false)
  archivedAt           DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  monthlyFeeP          Int?
  feeDueDay            Int?
  Attendance           Attendance[]
  Org                  Org                    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User                 User?                  @relation(fields: [teacherId], references: [id])
  Event                Event[]
  Exam                 Exam[]
  MonthlyPaymentRecord MonthlyPaymentRecord[]
  StudentClass         StudentClass[]
}

model Event {
  id          String   @id
  orgId       String
  title       String
  type        String
  date        DateTime
  startTime   String?
  endTime     String?
  location    String?
  teacher     String?
  description String?
  classId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  studentId   String?
  Class       Class?   @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student     Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Exam {
  id        String   @id
  orgId     String
  title     String
  date      DateTime
  classId   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  Class     Class?   @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model FeesPlan {
  id        String   @id
  orgId     String
  name      String
  amountP   Int
  cadence   String   @default("MONTHLY")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model GiftAidSubmission {
  id            String   @id
  orgId         String
  generatedById String
  startDate     DateTime
  endDate       DateTime
  totalAmount   Float
  totalCount    Int
  filename      String
  createdAt     DateTime @default(now())
  User          User     @relation(fields: [generatedById], references: [id])
  Org           Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([generatedById])
  @@index([orgId])
}

model Holiday {
  id        String   @id
  orgId     String
  name      String
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Invitation {
  id         String    @id
  orgId      String
  email      String?
  phone      String?
  role       String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())
  Org        Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Invoice {
  id         String    @id
  orgId      String
  studentId  String
  amountP    Int
  dueDate    DateTime
  status     String    @default("DRAFT")
  paidAt     DateTime?
  paidMethod String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  Org        Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student    Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  Payment    Payment[]
}

model Lead {
  id                     String         @id
  orgName                String
  city                   String?
  country                String         @default("UK")
  estimatedStudents      Int?
  contactName            String?
  contactEmail           String?
  contactPhone           String?
  status                 String         @default("NEW")
  source                 String?
  lastContactAt          DateTime?
  nextContactAt          DateTime?
  notes                  String?
  assignedToUserId       String?
  convertedOrgId         String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime
  emailOutreachCompleted Boolean        @default(false)
  lastEmailSentAt        DateTime?
  lastEmailStage         String?
  User                   User?          @relation(fields: [assignedToUserId], references: [id])
  Org                    Org?           @relation(fields: [convertedOrgId], references: [id])
  LeadActivity           LeadActivity[]

  @@index([assignedToUserId])
  @@index([convertedOrgId])
  @@index([emailOutreachCompleted, nextContactAt])
  @@index([lastEmailStage])
  @@index([nextContactAt])
  @@index([status, assignedToUserId])
  @@index([status])
}

model LeadActivity {
  id              String   @id
  leadId          String
  type            String
  description     String
  createdAt       DateTime @default(now())
  createdByUserId String?
  outcome         String?
  User            User?    @relation(fields: [createdByUserId], references: [id])
  Lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([type])
}

model Message {
  id        String   @id
  orgId     String
  title     String
  body      String
  audience  String
  channel   String
  status    String   @default("DRAFT")
  targets   String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model MonthlyPaymentRecord {
  id        String    @id
  orgId     String
  studentId String
  classId   String
  month     String
  amountP   Int
  method    String?
  status    String    @default("PENDING")
  paidAt    DateTime?
  notes     String?
  reference String?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  Class     Class     @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org       Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student   Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, month])
  @@index([orgId, month])
  @@index([status])
}

model Org {
  id                     String                 @id
  name                   String
  slug                   String                 @unique
  timezone               String                 @default("Europe/London")
  settings               String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime
  status                 String                 @default("ACTIVE")
  pausedAt               DateTime?
  pausedReason           String?
  lastPaymentDate        DateTime?
  paymentFailureCount    Int                    @default(0)
  autoSuspendEnabled     Boolean                @default(true)
  address                String?
  phone                  String?
  email                  String?
  officeHours            String?
  stripeEnabled          Boolean                @default(false)
  stripePublishableKey   String?
  stripeSecretKey        String?
  stripeWebhookSecret    String?
  autoPaymentEnabled     Boolean                @default(true)
  cashPaymentEnabled     Boolean                @default(true)
  bankTransferEnabled    Boolean                @default(true)
  paymentInstructions    String?
  addressLine1           String?
  city                   String?
  postcode               String?
  publicEmail            String?
  publicPhone            String?
  deactivatedAt          DateTime?
  deactivatedReason      String?
  bankAccountName        String?
  bankAccountNumber      String?
  bankSortCode           String?
  feeDueDay              Int?                   @default(1)
  stripeConnectAccountId String?
  acceptsCard            Boolean                @default(false)
  acceptsCash            Boolean                @default(true)
  acceptsBankTransfer    Boolean                @default(true)
  billingDay             Int?                   @default(1)
  Application            Application[]
  Attendance             Attendance[]
  AuditLog               AuditLog[]
  Class                  Class[]
  Event                  Event[]
  Exam                   Exam[]
  FeesPlan               FeesPlan[]
  GiftAidSubmission      GiftAidSubmission[]
  Holiday                Holiday[]
  Invitation             Invitation[]
  Invoice                Invoice[]
  Lead                   Lead[]
  Message                Message[]
  MonthlyPaymentRecord   MonthlyPaymentRecord[]
  ParentBillingProfile   ParentBillingProfile[]
  ParentInvitation       ParentInvitation[]
  Payment                Payment[]
  PlatformOrgBilling     PlatformOrgBilling?
  ProgressLog            ProgressLog[]
  Student                Student[]
  StudentClass           StudentClass[]
  SupportTicket          SupportTicket[]
  ParentStudentLink      ParentStudentLink[]
  Term                   Term[]
  UserOrgMembership      UserOrgMembership[]
}

model ParentBillingProfile {
  id                     String   @id
  orgId                  String
  parentUserId           String   @unique
  stripeCustomerId       String?
  defaultPaymentMethodId String?
  autoPayEnabled         Boolean  @default(false)
  preferredPaymentMethod String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime
  Org                    Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User                   User     @relation(fields: [parentUserId], references: [id], onDelete: Cascade)

  @@unique([orgId, parentUserId])
}

model ParentInvitation {
  id          String    @id
  orgId       String
  studentId   String
  parentEmail String
  token       String    @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  Org         Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([parentEmail])
  @@index([token])
}

model ParentStudentLink {
  id        String    @id
  orgId     String
  parentId  String
  studentId String
  claimedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  Org       Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User      User      @relation("ParentStudentLinks", fields: [parentId], references: [id], onDelete: Cascade)
  Student   Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
  @@index([parentId])
  @@index([studentId])
  @@index([orgId])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Payment {
  id         String   @id
  orgId      String
  invoiceId  String
  method     String
  amountP    Int
  status     String   @default("PENDING")
  providerId String?
  meta       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  Org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model PlatformOrgBilling {
  id                       String    @id
  orgId                    String    @unique
  stripeCustomerId         String?
  stripeSubscriptionItemId String?
  lastUsageReportedAt      DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime
  billingAnniversaryDate   Int?
  defaultPaymentMethodId   String?
  lastBilledAt             DateTime?
  lastBilledStudentCount   Int?
  stripeSubscriptionId     String?
  subscriptionStatus       String?
  trialEndDate             DateTime?
  firstPaymentFailureDate  DateTime?
  lastPaymentRetryDate     DateTime?
  paymentRetryCount        Int       @default(0)
  warningEmailSent         Boolean   @default(false)
  Org                      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model ProgressLog {
  id          String   @id
  orgId       String
  studentId   String
  body        String
  createdById String
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [createdById], references: [id])
  Org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StaffPermission {
  id                        String                      @id
  key                       String                      @unique
  name                      String
  description               String?
  category                  String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  StaffPermissionAssignment StaffPermissionAssignment[]
}

model StaffPermissionAssignment {
  id                String            @id
  membershipId      String
  permissionId      String
  createdAt         DateTime          @default(now())
  UserOrgMembership UserOrgMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  StaffPermission   StaffPermission   @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([membershipId, permissionId])
  @@index([membershipId])
}

model Student {
  id                   String                 @id
  orgId                String
  firstName            String
  lastName             String
  dob                  DateTime?
  allergies            String?
  medicalNotes         String?
  primaryParentId      String?
  paymentMethod        String?
  isArchived           Boolean                @default(false)
  archivedAt           DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  // Parent Claim System fields
  claimCode            String?                @unique
  claimCodeExpiresAt   DateTime?
  claimedByParentId    String?
  claimStatus          String                 @default("NOT_CLAIMED") // NOT_CLAIMED, PENDING_VERIFICATION, CLAIMED
  Attendance           Attendance[]
  Event                Event[]
  Invoice              Invoice[]
  MonthlyPaymentRecord MonthlyPaymentRecord[]
  ParentInvitation     ParentInvitation[]
  ProgressLog          ProgressLog[]
  Org                  Org                    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User                 User?                  @relation("StudentPrimaryParent", fields: [primaryParentId], references: [id])
  ClaimedByParent      User?                  @relation("ClaimedStudents", fields: [claimedByParentId], references: [id])
  StudentClass         StudentClass[]
  ParentStudentLink    ParentStudentLink[]

  @@index([claimCode])
  @@index([claimStatus])
  @@index([claimedByParentId])
}

model StudentClass {
  id        String  @id
  orgId     String
  studentId String
  classId   String
  Class     Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  Org       Org     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  Student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
}

model SupportTicket {
  id                    String                  @id
  orgId                 String
  createdById           String?
  role                  String
  subject               String
  body                  String
  status                String                  @default("OPEN")
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  User                  User?                   @relation(fields: [createdById], references: [id])
  Org                   Org                     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  SupportTicketResponse SupportTicketResponse[]
}

model SupportTicketResponse {
  id            String        @id
  ticketId      String
  body          String
  createdById   String
  createdAt     DateTime      @default(now())
  User          User          @relation(fields: [createdById], references: [id])
  SupportTicket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model Term {
  id        String   @id
  orgId     String
  name      String
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model User {
  id                     String                  @id
  name                   String?
  email                  String                  @unique
  emailVerified          DateTime?
  image                  String?
  phone                  String?
  backupPhone            String?
  password               String?
  isSuperAdmin           Boolean                 @default(false)
  isArchived             Boolean                 @default(false)
  archivedAt             DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  failedLoginAttempts    Int                     @default(0)
  lastFailedLoginAttempt DateTime?
  lockedUntil            DateTime?
  lastTwoFactorAt        DateTime?
  twoFactorCode          String?
  twoFactorCodeExpiry    DateTime?
  twoFactorEnabled       Boolean                 @default(true)
  address                String?
  giftAidDeclaredAt      DateTime?
  giftAidStatus          String?
  postcode               String?
  title                  String?
  city                   String?
  Account                Account[]
  Application            Application[]
  AuditLog               AuditLog[]
  Class                  Class[]
  ClaimedStudents        Student[]               @relation("ClaimedStudents")
  ParentStudentLinks     ParentStudentLink[]     @relation("ParentStudentLinks")
  PrimaryParentStudents  Student[]               @relation("StudentPrimaryParent")
  GiftAidSubmission      GiftAidSubmission[]
  Lead                   Lead[]
  LeadActivity           LeadActivity[]
  ParentBillingProfile   ParentBillingProfile?
  PasswordResetToken     PasswordResetToken[]
  ProgressLog            ProgressLog[]
  Session                Session[]
  SupportTicket          SupportTicket[]
  SupportTicketResponse  SupportTicketResponse[]
  UserOrgMembership      UserOrgMembership[]
}

model UserOrgMembership {
  id                        String                      @id
  userId                    String
  orgId                     String
  role                      String
  isInitialAdmin            Boolean                     @default(false)
  staffSubrole              String?
  StaffPermissionAssignment StaffPermissionAssignment[]
  Org                       Org                         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  User                      User                        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model platform_settings {
  id                          String    @id
  defaultTimezone             String    @default("Europe/London")
  trialPeriodDays             Int       @default(14)
  logoUrl                     String?
  faviconUrl                  String?
  resendApiKey                String?
  emailFromAddress            String?   @default("Madrasah OS <noreply@madrasah.io>")
  maintenanceMode             Boolean   @default(false)
  maintenanceMessage          String?
  scheduledMaintenanceAt      DateTime?
  basePricePerStudent         Int       @default(100)
  billingDayOfMonth           Int       @default(1)
  gracePeriodDays             Int       @default(14)
  autoBillingEnabled          Boolean   @default(true)
  billingNotificationsEnabled Boolean   @default(true)
  stripePublishableKey        String?
  stripeSecretKey             String?
  stripeWebhookSecret         String?
  stripeTestMode              Boolean   @default(true)
  passwordMinLength           Int       @default(8)
  passwordRequireUppercase    Boolean   @default(true)
  passwordRequireLowercase    Boolean   @default(true)
  passwordRequireNumbers      Boolean   @default(true)
  passwordRequireSpecial      Boolean   @default(false)
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime
  ownerCalendlyUrl            String?
}
